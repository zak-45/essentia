name: Multi-Python Windows Essentia Wheels Build

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  windows:
    name: Windows Python ${{ matrix.python-version }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.11"
          - "3.12"
          - "3.13"

    defaults:
      run:
        shell: pwsh

    steps:
      # ------------------------
      # Checkout repository
      # ------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ------------------------
      # Setup Python
      # ------------------------
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Upgrade pip and tools
        run: |
          python -m pip install --upgrade pip setuptools wheel numpy

      # ------------------------
      # Install Essentia dependencies (FFTW, FFmpeg, etc.)
      # ------------------------
      - name: Install dependencies
        run: .\packaging\build-dependencies-msvc.bat --static --build-type Release

      # ------------------------
      # Download FFmpeg DLLs
      # ------------------------
      - name: Download FFmpeg
        run: |
          $ffmpegZip = "ffmpeg-release-essentials.zip"
          Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile $ffmpegZip
          Expand-Archive $ffmpegZip -DestinationPath ffmpeg
          # move inner folder contents to ffmpeg root
          Get-ChildItem -Directory ffmpeg | ForEach-Object { Get-ChildItem $_.FullName | Move-Item -Destination ffmpeg -Force }

      # ------------------------
      # Configure CMake
      # ------------------------
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          $pythonExe = (Get-Command python).Source
          cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DBUILD_PYTHON_BINDINGS=ON `
            -DPYTHON_EXECUTABLE="$pythonExe" `
            -DBUILD_TESTS=OFF `
            -DBUILD_EXAMPLES=OFF `
            -DENABLE_STATIC_DEPENDENCIES=ON `
            -DCMAKE_PREFIX_PATH=%CD%\packaging\msvc

      # ------------------------
      # Build
      # ------------------------
      - name: Build Essentia
        run: |
          cd build
          set PATH=%PATH%;%CD%\..\packaging\msvc\bin
          cmake --build . --config Release --parallel

      # ------------------------
      # Copy _essentia.pyd and DLLs to Python package
      # ------------------------
      - name: Prepare Python package
        run: |
          mkdir -Force src\python\essentia
          Set-Content src\python\essentia\__init__.py "# Essentia Python bindings"

          # Copy _essentia.pyd
          $pyd = Get-ChildItem -Recurse build -Filter "_essentia*.pyd" | Select-Object -First 1
          if (-not $pyd) { Write-Error "No _essentia.pyd found"; exit 1 }
          Copy-Item $pyd.FullName src\python\essentia\

          # Copy DLLs: FFTW + FFmpeg + any Essentia dependencies
          Copy-Item packaging\msvc\bin\*.dll src\python\essentia\ -Force
          Copy-Item ffmpeg\bin\*.dll src\python\essentia\ -Force

          # Patch __init__.py to load DLLs
          Add-Content src\python\essentia\__init__.py ""
          Add-Content src\python\essentia\__init__.py "import os, sys"
          Add-Content src\python\essentia\__init__.py "from pathlib import Path"
          Add-Content src\python\essentia\__init__.py "if sys.platform == 'win32':"
          Add-Content src\python\essentia\__init__.py "    os.add_dll_directory(str(Path(__file__).parent))"

      # ------------------------
      # Build wheel
      # ------------------------
      - name: Build wheel
        run: |
          cd src\python
          python -m pip install --upgrade setuptools wheel
          python setup.py bdist_wheel

      # ------------------------
      # Upload artifact
      # ------------------------
      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: essentia-win-cp${{ matrix.python-version }}
          path: src\python/dist/*.whl

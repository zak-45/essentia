name: Cross Platform essentia wheels Build with CMake

on:
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  windows:
    name: Windows Python ${{ matrix.python }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        python:
          - "3.9.19"
          - "3.10.14"
          - "3.11.9"
          - "3.12.3"
          - "3.13.3"

    defaults:
      run:
        shell: cmd

    steps:
      # ------------------------
      # Checkout
      # ------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'true'

      # ------------------------
      # Install Python (debug build!)
      # ------------------------
      - name: Install Python ${{ matrix.python }}
        shell: pwsh
        run: |
          $ver = "${{ matrix.python }}"
          $short = ($ver -split '\.')[0..1] -join ''
          $exe = "python-$ver-amd64.exe"

          curl -L -o $exe https://www.python.org/ftp/python/$ver/$exe

          Start-Process -FilePath .\$exe `
            -ArgumentList "/quiet Include_debug=1 Include_dev=1 Include_lib=1 Include_pip=1 PrependPath=0 InstallAllUsers=0" `
            -Wait

          $root = "C:\Users\runneradmin\AppData\Local\Programs\Python\Python$short"

          Add-Content $env:GITHUB_PATH "$root"
          Add-Content $env:GITHUB_PATH "$root\Scripts"

          echo "PYTHON_ROOT=$root" >> $env:GITHUB_ENV

      # ------------------------
      # Install numpy
      # ------------------------
      - name: Install numpy
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy

      # ------------------------
      # Install Essentia deps (official)
      # ------------------------
      - name: Install dependencies
        run: |
          .\packaging\build-dependencies-msvc.bat --static --build-type Release

      # ------------------------
      # Configure
      # ------------------------
      - name: Configure
        run: |
          cmake -B build ^
            -DUSE_TENSORFLOW=ON ^
            -DBUILD_PYTHON_BINDINGS=ON ^
            -DPython3_ROOT_DIR=%PYTHON_ROOT% ^
            -DENABLE_STATIC_DEPENDENCIES=ON ^
            -DCMAKE_PREFIX_PATH=%CD%\packaging\msvc

      # ------------------------
      # Build
      # ------------------------
      - name: Build
        run: |
          set PATH=%PATH%;%CD%\packaging\msvc\bin
          cmake --build build --config %BUILD_TYPE% --parallel

      # ------------------------
      # Test
      # ------------------------
      - name: Test
        run: |
          set PATH=%PATH%;%CD%\packaging\msvc\bin
          ctest --test-dir build --output-on-failure -C %BUILD_TYPE%

      # ------------------------
      # Build Python wheel
      # ------------------------
      - name: Build wheel
        shell: pwsh
        run: |
          cd src\python
          python -m pip install --upgrade setuptools wheel
          python setup.py bdist_wheel

      # ------------------------
      # Upload wheel
      # ------------------------
      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: essentia-win-cp${{ matrix.python }}
          path: src/python/dist/*.whl

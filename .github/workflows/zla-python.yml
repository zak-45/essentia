name: Build Essentia Windows Python Wheels

on:
  workflow_dispatch:

jobs:
  build-wheels:
    runs-on: windows-2022

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]

    steps:
    # ------------------------
    # Checkout repo
    # ------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # ------------------------
    # Setup Python
    # ------------------------
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: x64

    - name: Upgrade pip and tools
      shell: pwsh
      run: |
        python -m pip install --upgrade pip setuptools wheel numpy

    # ------------------------
    # Setup MSVC
    # ------------------------
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    # ------------------------
    # Install FFTW + Eigen3 via vcpkg  ✅ FIX
    # ------------------------
    - name: Install dependencies with vcpkg
      shell: pwsh
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        .\vcpkg\vcpkg install fftw3:x64-windows eigen3:x64-windows

    # ------------------------
    # Download FFmpeg DLLs
    # ------------------------
    - name: Download FFmpeg
      shell: pwsh
      run: |
        $zip = "ffmpeg-release-essentials.zip"
        Invoke-WebRequest `
          -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" `
          -OutFile $zip
        Expand-Archive $zip -DestinationPath ffmpeg
        Get-ChildItem -Directory ffmpeg | ForEach-Object {
          Get-ChildItem $_.FullName | Move-Item -Destination ffmpeg -Force
        }

    # ------------------------
    # Configure CMake  ✅ FIX
    # ------------------------
    - name: Configure CMake
      shell: pwsh
      run: |
        mkdir build
        cd build

        $pythonExe = (Get-Command python).Source
        $toolchain = Resolve-Path ..\vcpkg\scripts\buildsystems\vcpkg.cmake

        cmake .. `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
          -DBUILD_PYTHON=ON `
          -DPYTHON_EXECUTABLE="$pythonExe" `
          -DBUILD_TESTS=OFF `
          -DBUILD_EXAMPLES=OFF

    # ------------------------
    # Build
    # ------------------------
    - name: Build Essentia
      shell: pwsh
      run: |
        cd build
        cmake --build . --config Release --parallel

    # ------------------------
    # Create minimal Python package
    # ------------------------
    - name: Create minimal Python package
      shell: pwsh
      run: |
        mkdir -Force python\essentia
        Set-Content python\essentia\__init__.py "# Essentia Python bindings"

        $lines = @(
          "from setuptools import setup",
          "from setuptools.dist import Distribution",
          "",
          "class BinaryDistribution(Distribution):",
          "    def has_ext_modules(self):",
          "        return True",
          "",
          "setup(",
          "    name='essentia',",
          "    version='2.1b6.dev0',",
          "    packages=['essentia'],",
          "    package_data={'essentia': ['*.pyd','*.dll']},",
          "    distclass=BinaryDistribution,",
          ")"
        )

        $lines | Set-Content python\setup.py

    # ------------------------
    # Copy Python extension + DLLs
    # ------------------------
    - name: Copy Python extension and DLLs
      shell: pwsh
      run: |
        $pyd = Get-ChildItem -Recurse build -Filter "*.pyd" | Select-Object -First 1
        if (-not $pyd) { Write-Error "No .pyd found"; exit 1 }
        Copy-Item $pyd.FullName python\essentia\

        Copy-Item vcpkg\installed\x64-windows\bin\*.dll python\essentia\
        Copy-Item ffmpeg\bin\*.dll python\essentia\

    # ------------------------
    # Patch __init__.py
    # ------------------------
    - name: Patch DLL loading
      shell: pwsh
      run: |
        $init = "python\essentia\__init__.py"
        Add-Content $init ""
        Add-Content $init "import os, sys"
        Add-Content $init "from pathlib import Path"
        Add-Content $init "if sys.platform == 'win32':"
        Add-Content $init "    os.add_dll_directory(str(Path(__file__).parent))"

    # ------------------------
    # Build wheel
    # ------------------------
    - name: Build wheel
      shell: pwsh
      run: |
        cd python
        python setup.py bdist_wheel

    # ------------------------
    # Upload artifact
    # ------------------------
    - name: Upload wheels
      uses: actions/upload-artifact@v4
      with:
        name: essentia-win-py${{ matrix.python-version }}
        path: python/dist/*.whl
